import telebot
import module

bot = telebot.TeleBot('1753135807:AAHny8IXYQwV2kZo5R2kdB4dX2Ozfpgylzg')

keyboard_menu = telebot.types.ReplyKeyboardMarkup(True, True)
keyboard_menu.row("1", "2", "3")

keyboard_cont = telebot.types.ReplyKeyboardMarkup(True, True)
keyboard_cont.row("Продолжить", "Меню")

keyboard_cont_check = telebot.types.ReplyKeyboardMarkup(True, True)
keyboard_cont_check.row("Меню")

start_menu = "Добро пожаловать в стартовое меню! Для вас доступны следующие варианты: \n1." + \
             str(module.get_message("1.0.0")) \
             + "\n2." + str(module.get_message("2.0.0")) + "\n3. Продолжить"


@bot.message_handler(commands=['start'])
def start_message(message):
    module.add_user(int(message.chat.id))
    module.set_level(int(message.chat.id), "1.1.0")
    print(message.chat)
    bot.send_message(message.chat.id, "Добро пожаловать в нашего обучающего бота!")
    menu_message(message)


@bot.message_handler(commands=['help'])
def help_message(message):
    bot.send_message(message.chat.id, 'Моли о помощи.....')
    menu_message(message)


def menu_message(message):
    print("menu_message")
    msg = bot.send_message(message.chat.id, start_menu, reply_markup=keyboard_menu)
    bot.register_next_step_handler(msg, course_start)


def course_start(message):
    print("cource_start")
    try:
        num = int(message.text)
        if num > 3:
            bot.send_message(message.chat.id, "Я тебя не понял1.")
            menu_message(message)
        if num == 1 or num == 2:
            module.set_level(message.chat.id, str(num) + ".1.0")
            course_continue(message)
        elif num == 3:
            course_continue(message)

    except Exception:
        bot.send_message(message.chat.id, "Я тебя не понял2.")
        menu_message(message)


def course_continue(message):
    print("cource_cont")
    if message.text == "Меню":
        menu_message(message)
    elif message.text == "1" or message.text == "2" or message.text == "3" or message.text == "Продолжить":
        if module.get_message(module.get_user(str(message.chat.id))[2]) == "Ничего не найдено по данному запросу":
            bot.send_message(message.chat.id,
                             "Что-ж, вот вы и закончили этот курс! Посмотрите, что еще мы можем вам предложить: ")
            module.set_level(message.chat.id, "1.1.0")
            menu_message(message)
        else:
            if module.get_answer(module.get_user(str(message.chat.id))[2]) == "-":
                msg = bot.send_message(message.chat.id,
                                       module.get_message(module.get_user(str(message.chat.id))[2]),
                                       reply_markup=keyboard_cont)
                lvl = module.get_user(str(message.chat.id))[2].split(".")
                lvl[1] = str(int(lvl[1]) + 1)
                module.set_level(message.chat.id, lvl[0] + "." + lvl[1] + "." + lvl[2])
                bot.register_next_step_handler(msg, course_continue)
            else:
                msg = bot.send_message(message.chat.id,
                                       module.get_message(module.get_user(str(message.chat.id))[2]),
                                       reply_markup=keyboard_cont_check)
                bot.register_next_step_handler(msg, check_answer)
    else:
        bot.send_message(message.chat.id, "Я тебя не понял2.")
        menu_message(message)


def check_answer(message):
    print("check_answer")
    if message.text == "Меню":
        menu_message(message)
    else:
        ans = module.get_answer(module.get_user(str(message.chat.id))[2])[0]
        # lvl = get_level(base, message.chat.id).split(".")

        if message.text == ans:
            # lvl[2] = "1"
            # print(get_message(base, ".".join(lvl)))
            msg = bot.send_message(message.chat.id, "Все верно!", reply_markup=keyboard_cont)
            lvl = module.get_user(str(message.chat.id))[2].split(".")
            lvl[1] = str(int(lvl[1]) + 1)
            module.set_level(message.chat.id, lvl[0] + "." + lvl[1] + "." + lvl[2])
            bot.register_next_step_handler(msg, course_continue)
        else:
            msg = bot.send_message(message.chat.id, "Это неправильный ответ.", reply_markup=keyboard_cont_check)
            bot.register_next_step_handler(msg, check_answer)


bot.polling()
